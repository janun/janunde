{% extends "core/__base.html" %}
{% load wagtailcore_tags wagtailimages_tags nettes_datum %}
{% load static from staticfiles %}
{% load cache %}

{% block content %}
  <div class="max-w-5xl xl:max-w-6xl mx-auto px-4">

    <div class="lg:flex flex-wrap items-center justify-between my-8 md:my-16">
      <h1 class="text-green-500 text-2xl md:text-3xl font-bold mb-6 lg:mb-0 mt-0">
        <a class="text-green-500" href="{% pageurl self %}">{{ self.heading }}</a>
      </h1>

      {% comment %} search field {% endcomment %}
      <form class="flex items-center flex-1 max-w-md lg:ml-8" action="{% pageurl self %}" method="GET">
        <div class="flex items-center relative w-full">
          <input autocomplete="off" type="text" {% if q %}autofocus{% endif %} name="q" value="{{ q }}" class="pl-10 w-full bg-white border border-gray-400 outline-none focus:shadow-outline rounded-md p-2" placeholder="Veranstaltungen durchsuchen">
          <svg class="fill-current text-gray-600 absolute left-0 w-4 h-4 ml-3" viewBox="0 0 20 20"><path d="M12.9 14.32a8 8 0 1 1 1.41-1.41l5.35 5.33-1.42 1.42-5.33-5.34zM8 14A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/></svg>
        </div>
      </form>
    </div>
    
    {% regroup events by month as events_by_month %}
      
    <div class="md:flex items-start justify-between js-scroll-spy">
      <aside class="md:sticky md:mr-8 text-gray-700" style="top: 80px">
        <ul class="flex mb-12 md:mb-8 -mx-2">
          <li class="mx-2">
            <a class="py-2 border-b-2 text-gray-700 {% if past or q %}border-transparent{% else %}text-green-600 border-green-400{% endif %}"
              href="{% pageurl self %}">Aktuell</a>
          </li>
          <li class="mx-2">
            <a class="py-2 border-b-2 text-gray-700 {% if past and not q %}text-green-600 border-green-400{% else %}border-transparent{% endif %}"
              href="{% pageurl self %}?past=1&year={% now "Y" %}&month={% now "m" %}">Vergangenheit</a>
          </li>
          {% if q %}
            <li class="mx-2">
              <span class="py-2 border-b-2 text-green-600 border-green-400">Suche</span>
            </li>
          {% endif %}
        </ul>

        {% if past %}
          {% regroup months by year as months_by_year %}
          <ul class="hidden md:block">
            {% for y in months_by_year reversed %}
              <li class="mb-5">
                {% if year == y.grouper %}
                  <div class="text-green-500 mb-2 text-xs">{{ y.grouper }}</div>
                  <ul>
                    {% for m in y.list reversed %}
                      <li class="mb-2">
                        <a href="{% pageurl self %}?past=1&year={{ m.year }}&month={{ m.month }}"
                          class="{% if m.year == year and m.month == month %}text-green-500{% else %}text-gray-700 hover:text-green-500{% endif %}">
                          {{ m|date:"F" }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <a class="text-xs text-gray-700 hover:text-green-500" href="{% pageurl self %}?past=1&year={{ y.grouper }}&month=12">{{ y.grouper }}</a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          {% regroup events_by_month by grouper.year as events_by_year %}
          <ul class="hidden md:block js-scroll-spy-menu" data-js-scroll-spy-class="text-green-500" data-offset="10">
            {% for year in events_by_year %}
              <li class="mb-5">
                <div class="mb-2 text-gray-600 text-xs">{{ year.grouper }}</div>
                <ul>
                  {% for events in year.list %}
                    <li class="mb-2">
                      <a class="text-gray-700 hover:text-green-500" href="#{{ events.grouper|date:"Y-m" }}">{{ events.grouper|date:"F" }}</a>
                    </li>
                  {% endfor %}
                </ul>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        {% comment %} desktop pagination for search {% endcomment %}
        {% if events.paginator.num_pages > 1 %}
          <ul class="hidden md:flex -mx-2 my-10">
            {% if events.has_previous %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.previous_page_number }}">
                  <span>←</span>
                </a>
              </li>
            {% endif %}

            {% for page_num in events.paginator.page_range %}
              <li>
                <a class="mx-1 p-1 px-3 rounded text-gray-700 {% if page_num == events.number %}bg-green-200{% endif %}"
                  href="?q={{ q }}&page={{ page_num }}">
                  {{ page_num }}
                </a>
              </li>
            {% endfor %}

            {% if events.has_next %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.next_page_number }}">
                  <span>→</span>
                </a>
              </li>
            {% endif %}
          </ul>
        {% endif %}
      </aside>

      <main class="w-full max-w-3xl">
        {% if q %}
          {% if events_by_month %}
            <div class="text-green-500 font-bold text-xl mb-6">{{ search_count }} Suchergebnisse für „{{ q }}“:</div>
          {% else %}
            <div>
              <svg class="fill-current text-red-500 h-16 w-16 mb-6" width="32" height="32" viewBox="0 0 32 32"><path d="M16 0C8.84 0 3 6.24 3 13.92v17.09a1 1 0 001.75.67l3.77-4.16 2.95 4.07a1 1 0 001.61 0l2.96-3.97 2.92 3.98a1 1 0 001.61 0l2.99-4.08 3.68 4.15A1 1 0 0029 31V13.92C29 6.24 23.16 0 16 0zm10.99 28.38l-2.76-3.1a1 1 0 00-1.55.07l-2.92 3.96-2.9-3.96a1 1 0 00-.8-.41h-.01a1 1 0 00-.8.4l-2.96 3.98-2.88-3.97a1 1 0 00-.75-.42H8.6a1 1 0 00-.74.33l-2.85 3.15V13.92C5 7.35 9.94 2 16 2s10.99 5.35 10.99 11.92v14.46zM21 11a2 2 0 100 4 2 2 0 000-4zm-10 0a2 2 0 100 4 2 2 0 000-4z"/></svg>
              <div class="font-bold text-red-500 mb-4 text-lg text-xl md:text-2xl">Sorry, leider nichts gefunden für „{{ q }}“</div>            
              <div class="text-gray-700">Versuche es mal mit einem anderen Suchbegriff.</div>
            </div>
          {% endif %}
        {% endif %}

        {% for events in events_by_month %}
          <div class="mb-10 md:mb-20">
            <h2 id="{{ events.grouper|date:"Y-m" }}" class="js-scroll-spy-section pt-20 -mt-20 text-gray-700 text-base mb-5">
              {% if past or q %}{{ events.grouper|date:"F Y" }}{% else %}{{ events.grouper|format_month }}{% endif %}
            </h2>
              {% for event in events.list %}
              {% cache 600 newevent event.id event.latest_revision_created_at event.main_image.updated_at %}

                <div class="relative mb-8 md:mb-12 h-32 md:h-36 -mx-4 sm:mx-0">
                  <a class="block group overflow-hidden flex bg-white shadow md:shadow-md hover:shadow-lg text-gray-700 sm:rounded-lg h-32 md:h-36" href="{% pageurl event %}">
                    
                    {% image event.main_image fill-448x228 format-jpeg   as main_image %}
                    <img {{ main_image.attrs }} loading="lazy" class="object-cover sm:rounded-bl-lg sm:rounded-tl-lg w-32 md:w-56 border-r">
                    
                    <div class="p-3 pt-2 md:p-5 md:pt-4 overflow-hidden">
                      <div class="text-xs md:text-sm mb-1 sm:mb-2 truncate">
                        {% if event.multipledays %}
                          <time title="{{ event.start }}">{{ event.start|date:"D j.n." }}</time>
                          <time title="{{ event.end }}"> – {{ event.end|date:"D j.n." }}</time>
                        {% else %}
                          <time title="{{ event.start }}">
                            {{ event.start|date:"D j.n." }}
                            {% if event.start|time:"G:i" %}{{ event.start|time:"G:i" }}{% endif %}
                          </time>
                        {% endif %}

                        {% if event.location_city %}
                          <span>in {{ event.location_city|truncatechars:25 }}</span>
                          {% if event.location_country != "Deutschland" %}
                            <span>{{ event.location_country|truncatechars:25 }}</span>
                          {% endif %}
                        {% elif event.location %}
                          <span title="{{ event.location }}">in {{ event.location|truncatechars:30 }}</span>
                        {% elif event.location_name %}
                          <span>in {{ event.location_name|truncatechars:30 }}</span>
                        {% endif %}
                      </div>

                      <h3 class="text-brown text-lg md:text-xl mb-1 font-semibold group-hover:text-green-500">{{ event.title }}</h3>
                      {% if event.subtitle %}
                        <div class="hidden md:block text-xs md:text-sm" title="{{ event.subtitle }}">{{ event.subtitle|truncatechars:120 }}</div>
                        <div class="md:hidden text-xs md:text-sm" title="{{ event.subtitle }}">{{ event.subtitle|truncatechars:50 }}</div>
                      {% endif %}
                    </div>

                  </a>
                  {% if event.related_group %}
                    <a href="{% pageurl event.related_group %}" title="{{ event.related_group.title }}"
                       class="absolute w-14 h-14 top-0 right-0 -mt-3 md:-mt-5 sm:-mr-2 md:-mr-4 sm:w-18 sm:h-18 overflow-hidden shadow-md border hover:border-gray-500 hover:shadow-lg p-2 sm:p-3 bg-white flex items-center justify-center rounded-full"
                       >
                      {% if event.related_group.logo %}
                        {% image event.related_group.logo min-112x112 as group_logo %}
                        <img {{ group_logo.attrs }} loading="lazy" class="w-full h-full object-contain">
                      {% else %}
                        <div class="text-center text-xs leading-tight">{{ event.related_group.title }}</div>
                      {% endif %}
                    </a>
                  {% endif %}
                </div>

                <script type="application/ld+json">
                {
                  "@context": "https://schema.org",
                  "@type": "Event",
                  "name": "{{ event.title }}",
                  "url": "{{ event.full_url }}",
                  "description": "{{ event.subtitle|default:'' }}",
                  "image": "{{ main_image.url }}",
                  "startDate": "{{ event.start|date:'c' }}",
                  "endDate": "{{ event.end|date:'c' }}",
                  "organizer": "{{ event.organizer|default:event.related_group|default:'' }}",
                  "location": {
                    "@type": "Place",
                    "name": "{{ event.location_name|default:event.location|default:'' }}",
                    "address": "{{ event.address|default:event.location|default:'kein Ort' }}"
                  }
                }
                </script>

              {% endcache %}
              {% endfor %}
            </div>
        {% endfor %}

        {% comment %} mobile pagination for search {% endcomment %}
        {% if events.paginator.num_pages > 1 %}
          <ul class="md:hidden flex -mx-2 my-10">
            {% if events.has_previous %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.previous_page_number }}">
                  <span>←</span>
                </a>
              </li>
            {% endif %}

            {% for page_num in events.paginator.page_range %}
              <li>
                <a class="mx-1 p-1 px-3 rounded text-gray-700 {% if page_num == events.number %}bg-green-200{% endif %}"
                  href="?q={{ q }}&page={{ page_num }}">
                  {{ page_num }}
                </a>
              </li>
            {% endfor %}

            {% if events.has_next %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.next_page_number }}">
                  <span>→</span>
                </a>
              </li>
            {% endif %}
          </ul>
        {% endif %}

        {% comment %} pagination for past {% endcomment %}
        {% if past %}
          <div class="flex items-center justify-between my-12">
            {% if prev_month %}
              <a class="text-gray-700 hover:text-green-500" href="{% pageurl self %}?past=1&year={{ prev_month.year }}&month={{ prev_month.month }}">← {{ prev_month|date:"F Y" }}</a>
            {% endif %}

            {% if next_month %}
              <a class="ml-auto text-gray-700 hover:text-green-500" href="{% pageurl self %}?past=1&year={{ next_month.year }}&month={{ next_month.month }}">{{ next_month|date:"F Y" }} →</a>
            {% endif %}
          </div>
        {% endif %}

      </main>
    </div>

  </div>
{% endblock %}
