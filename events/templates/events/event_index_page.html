{% extends "core/__base.html" %}
{% load wagtailcore_tags wagtailimages_tags nettes_datum %}
{% load static from staticfiles %}
{% load cache %}

{% block content %}
  <div class="max-w-6xl mx-auto px-4">

    <div class="flex flex-wrap items-center justify-between my-8 md:my-16">
      <h1 class="text-green-500 text-2xl md:text-3xl font-bold mb-6 sm:mb-0 mt-0">{{ self.heading }}</h1>

      <form class="flex items-center w-full max-w-sm" action="{% pageurl self %}" method="GET">
        <div class="flex items-center relative w-full">
          <input autocomplete="off" type="text" name="q" value="{{ q }}" class="pl-10 w-full bg-white border border-gray-400 outline-none focus:shadow-outline rounded-md p-2" placeholder="Veranstaltungen durchsuchen">
          <svg class="fill-current text-gray-600 absolute left-0 w-4 h-4 ml-3" viewBox="0 0 20 20"><path d="M12.9 14.32a8 8 0 1 1 1.41-1.41l5.35 5.33-1.42 1.42-5.33-5.34zM8 14A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/></svg>
        </div>
      </form>
    </div>
    
    {% regroup events by month as events_by_month %}
      
    <div class="flex items-start justify-between">
      <aside class="hidden md:block sticky mr-5 text-gray-700" style="top: 80px">
        <ul class="flex mb-8 -mx-2">
          <li class="mx-2">
            <a class="py-2 border-b-2 text-gray-700 {% if past or q %}border-transparent{% else %}text-green-600 border-green-400{% endif %}"
              href="{% pageurl self %}">Kommendes</a>
          </li>
          <li class="mx-2">
            <a class="py-2 border-b-2 text-gray-700 {% if past and not q %}text-green-600 border-green-400{% else %}border-transparent{% endif %}"
              href="{% pageurl self %}?past=1&year={% now "Y" %}&month={% now "m" %}">Vergangenes</a>
          </li>
          {% if q %}
            <li class="mx-2">
              <span class="py-2 border-b-2 text-green-600 border-green-400">Suche</span>
            </li>
          {% endif %}
        </ul>

        {% if past %}
          {% regroup months by year as months_by_year %}
          <ul>
            {% for y in months_by_year reversed %}
              <li class="mb-5">
                {% if year == y.grouper %}
                  <div class="text-green-500 mb-2">{{ y.grouper }}</div>
                  <ul>
                    {% for m in y.list reversed %}
                      <li class="ml-4 mb-2">
                        <a href="{% pageurl self %}?past=1&year={{ m.year }}&month={{ m.month }}"
                          class="{% if m.year == year and m.month == month %}text-green-500{% else %}text-gray-700 hover:text-green-500{% endif %}">
                          {{ m|date:"F" }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <a class="text-gray-700 hover:text-green-500" href="{% pageurl self %}?past=1&year={{ y.grouper }}&month=12">{{ y.grouper }}</a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          {% regroup events_by_month by grouper.year as events_by_year %}
          <ul>
            {% for year in events_by_year %}
              <li class="mb-5">
                <div class="mb-2">{{ year.grouper }}</div>
                <ul>
                  {% for events in year.list %}
                    <li class="ml-4 mb-2">
                      <a class="text-gray-700 hover:text-green-500" href="#{{ events.grouper|date:"Y-m" }}">{{ events.grouper|date:"F" }}</a>
                    </li>
                  {% endfor %}
                </ul>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        {% comment %} desktop pagination {% endcomment %}
        {% if events.paginator.num_pages > 1 %}
          <ul class="flex -mx-2 my-10">
            {% if events.has_previous %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.previous_page_number }}">
                  <span>←</span>
                </a>
              </li>
            {% endif %}

            {% for page_num in events.paginator.page_range %}
              <li>
                <a class="mx-1 p-1 px-3 rounded text-gray-700 {% if page_num == events.number %}bg-green-200{% endif %}"
                  href="?q={{ q }}&page={{ page_num }}">
                  {{ page_num }}
                </a>
              </li>
            {% endfor %}

            {% if events.has_next %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.next_page_number }}">
                  <span>→</span>
                </a>
              </li>
            {% endif %}
          </ul>
        {% endif %}
      </aside>

      <main class="w-full max-w-3xl">
        {% if q %}
          <div class="text-green-500 font-bold text-xl mb-6">{{ search_count }} Suchergebnisse für „{{ q }}“:</div>
        {% endif %}

        {% for events in events_by_month %}
          <div class="mb-10 md:mb-20">
            <h2 id="{{ events.grouper|date:"Y-m" }}" class="text-gray-700 text-base mb-5 mt-0">
              {% if past or q %}{{ events.grouper|date:"F Y" }}{% else %}{{ events.grouper|format_month }}{% endif %}
            </h2>
              {% for event in events.list %}
              {% cache 600 newevent event.id event.latest_revision_created_at event.main_image.updated_at %}

                <div class="relative mb-8 md:mb-12 h-32 md:h-36 -mx-4 sm:mx-0">
                  <a class="block group overflow-hidden flex bg-white shadow-md hover:shadow-lg text-gray-700 sm:rounded-lg h-32 md:h-36" href="{% pageurl event %}">
                    
                    {% image event.main_image max-600x400 as main_image %}
                    <img src="{{ main_image.url }}" alt="{{ main_image.alt }}" class="object-cover sm:rounded-bl-lg sm:rounded-tl-lg w-32 md:w-56 border-r">
                    
                    <div class="p-3 md:p-5 overflow-hidden">
                      <div class="text-xs md:text-sm mb-1 sm:mb-2 truncate">
                        {% if event.multipledays %}
                          <time title="{{ event.start }}">{{ event.start|date:"D d.m." }}</time>
                          <time title="{{ event.end }}"> bis {{ event.end|date:"D d.m." }}</time>
                        {% else %}
                          <time title="{{ event.start }}">
                            {{ event.start|date:"D d.m." }}
                            {% if event.start|time:"H:i" %}
                              {{ event.start|time:"H:i" }}
                            {% endif %}
                            {% if event.end|time:"H:i" %}
                              bis {{ event.end|time:"H:i" }}
                            {% endif %}
                          </time>
                        {% endif %}

                        <span title="{{ event.location }}">in {{ event.location|truncatechars:50 }}</span>
                      </div>

                      <h3 class="text-brown text-lg md:text-xl mb-1 font-semibold group-hover:text-green-500">{{ event.title }}</h3>
                      {% if event.subtitle %}
                        <div class="text-xs md:text-sm" title="{{ event.subtitle }}">{{ event.subtitle|truncatechars:100 }}</div>
                      {% endif %}
                    </div>

                  </a>
                  {% if event.related_group %}
                    <a href="{% pageurl event.related_group %}" title="{{ event.related_group.title }}"
                       class="absolute w-12 h-12 top-0 right-0 -mt-3 md:-mt-5 sm:-mr-2 md:-mr-4 sm:w-20 sm:h-20 overflow-hidden shadow-md hover:shadow-lg p-2 sm:p-3 bg-white flex items-center justify-center rounded-full"
                       >
                      {% image event.related_group.logo max-400x400 class="w-full h-full object-contain" %}
                    </a>
                  {% endif %}
                </div>

                <script type="application/ld+json">
                {
                  "@context": "https://schema.org",
                  "@type": "Event",
                  "name": "{{ event.title }}",
                  "url": "{{ event.full_url }}",
                  "description": "{{ event.subtitle|default:'' }}",
                  "image": "{{ main_image.url }}",
                  "startDate": "{{ event.start|date:'c' }}",
                  "endDate": "{{ event.end|date:'c' }}",
                  {% if event.location %}
                  "location": {
                    "@type": "Place",
                    "name": "{{ event.location }}",
                    "address": "{{ event.location }}"
                    }
                  }
                  {% endif %}
                }
                </script>

              {% endcache %}
              {% endfor %}
            </div>
        {% endfor %}

        {% comment %} mobile pagination {% endcomment %}
        {% if events.paginator.num_pages > 1 %}
          <ul class="md:hidden flex -mx-2 my-10">
            {% if events.has_previous %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.previous_page_number }}">
                  <span>←</span>
                </a>
              </li>
            {% endif %}

            {% for page_num in events.paginator.page_range %}
              <li>
                <a class="mx-1 p-1 px-3 rounded text-gray-700 {% if page_num == events.number %}bg-green-200{% endif %}"
                  href="?q={{ q }}&page={{ page_num }}">
                  {{ page_num }}
                </a>
              </li>
            {% endfor %}

            {% if events.has_next %}
              <li>
                <a class="p-1 px-3 rounded text-gray-700"
                  href="?q={{ q }}&page={{ events.next_page_number }}">
                  <span>→</span>
                </a>
              </li>
            {% endif %}
          </ul>
        {% endif %}

        {% comment %} pagination for past {% endcomment %}
        {% if past %}
          <div class="flex items-center justify-between">
            {% if next_month %}
              <a class="text-gray-700" href="{% pageurl self %}?past=1&year={{ next_month.year }}&month={{ next_month.month }}">← {{ next_month|date:"F Y" }}</a>
            {% endif %}
            {% if prev_month %}
              <a class="ml-auto text-gray-700" href="{% pageurl self %}?past=1&year={{ prev_month.year }}&month={{ prev_month.month }}">{{ prev_month|date:"F Y" }} →</a>
            {% endif %}
          </div>
        {% endif %}

      </main>
    </div>

  </div>
{% endblock %}
